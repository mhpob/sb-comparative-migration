---
title: "Initial cross-system data comparison"
date: '2022-01-20'
output:
  html_notebook: default
  # pdf_document: default
---



```{r}
library(ggplot2); library(data.table)

all_info <- fread('embargo/derived/combined_tag_info.csv',
                  na.strings = '')
all_info[, yr := as.factor(year(tagdate))]
all_info[, system := as.factor(system)]

all_info
```

## Systems

```{r}
xtabs(~  system, addNA = T, data = all_info)
```

## Year tagged

- Potomac tags skew older, Delaware tags skew younger, Massachusetts tags are in the middle, and Hudson were only tagged in 2016

- 2016 is the only year that had fish tagged in all systems

```{r}
# Cross-tabulation
addmargins(xtabs(~ yr + system, addNA = T, data = all_info))

# Dirty chi-squared test
summary(xtabs(~ yr + system, addNA = T, data = all_info))
```

```{r}
ggplot(data = all_info) +
  geom_bar(aes(x = yr, fill = system))
```
## Age

- Hudson River and a subset of Potomac-tagged fish have not yet been, but are planning to be, aged. There will likely wind up being no Hudson River *NA* and 1 Potomac River *NA*.

```{r}
# Cross-tabulation
addmargins(xtabs(~ age + system, addNA = T, data = all_info))

# Dirty chi-squared test
summary(xtabs(~ age + system, addNA = T, data = all_info))

# Range of ages
all_info[, .(min = min(age, na.rm = T),
             median = median(age, na.rm = T),
             max = max(age, na.rm = T)), 
         by = system]
```

- Delaware fish are oldest, followed by Potomac, then Massachusetts.

```{r}
TukeyHSD(aov(age ~ system, data = all_info))
```


```{r}
ggplot(data = all_info) +
  geom_bar(aes(x = age, fill = yr)) +
  scale_fill_viridis_d() +
  facet_wrap(~ system) +
  labs(title = 'Age by year and system tagged')
```


```{r}
ggplot(data = all_info) +
  geom_bar(aes(x = age, fill = sex)) +
  facet_wrap(~ system) +
  labs(title = 'Age by system tagged and sex')
```



### Cursory system-sex-age ANOVA
- Analysis only includes DE- and Potomac-tagged fish (no sexes or lengths in MA and Hudson fish)
- Results shouldn't be taken at face value -- this is an unbalanced ANOVA being analyzed in a balances ANOVA framework and so should be better-analyzed in the future.

```{r}
plot(
  TukeyHSD(aov(age ~ system * sex * yr, data = all_info[sex != 'U']),
           'sex'), 
  las = 2
)
```

- Overall, tagged males were significantly younger than females.

```{r}
par(mar = c(4, 9.5, 2, 2))
plot(
  TukeyHSD(aov(age ~ system * sex * yr, data = all_info[sex != 'U']),
           'system:sex'), 
  las = 2
)
```

- DE- and Potomac-tagged males were significantly younger than their female counterparts

- Potomac-tagged females were significantly younger than DE-tagged; Potomac- and DE-tagged males were barely significantly different in age at α = 0.05

- Potomac-tagged males were significantly younger than DE-tagged females; there was no significant difference between the age of DE-tagged males and Potomac-tagged females at α = 0.05

```{r}
par(mar = c(4, 5, 2, 2))
plot(
  TukeyHSD(aov(age ~ system * sex * yr, data = all_info[sex != 'U']),
           'yr'), 
  las = 2
)
```

- 2014-tagged fish were significantly older than 2018-tagged fish, significantly younger than 2019-tagged fish, and no significant difference for other years.


## Sexes

Fish collected off the Massachusetts coast and 21% of Potomac fish were not sexed. "*NA*" means that sex was not recorded, while "*U*" means that the sex was not able to be determined.

```{r}
# Cross-tabulation
addmargins(xtabs(~ sex + system, addNA = T, data = all_info))

# Dirty chi-squared test
summary(xtabs(~ sex + system, addNA = T, data = all_info))
```

```{r}
ggplot(data = all_info) +
  geom_bar(aes(x = yr, fill = sex)) +
  facet_wrap(~ system)
```

## Lengths

All fish collected have total lengths, while only Hudson fish have fork lengths. Seems TL is the way to go here.

```{r}
ggplot(data = all_info) +
  geom_histogram(aes(x = tl, fill = yr), binwidth = 50) +
  scale_fill_viridis_d() +
  facet_wrap(~ system, scales = 'free_y') +
  labs(title = 'Total length by year and tagged')
```
Massachusetts-tagged fish are _much_ smaller than other areas.

```{r}
ggplot(data = all_info) +
  geom_histogram(aes(x = tl, fill = yr), binwidth = 50) +
  scale_fill_viridis_d() +
  facet_grid(sex ~ system, scales = 'free_y') +
  labs(title = 'Total length by sex and year and system tagged')
```


## Weights

Only Potomac and Hudson fish have recorded weights, with Potomac fish skewing much lighter.

```{r}
all_info[!is.na(wgt), .N, by = system]

ggplot(data = all_info) +
  geom_histogram(aes(x = wgt, fill = yr), binwidth = 1000) +
  scale_fill_viridis_d() +
  facet_wrap(~ system, scales = 'free_y')
```

